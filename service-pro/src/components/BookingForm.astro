---
import { SITE } from "@/config/site";

const { serviceTitle } = Astro.props as { serviceTitle: string };

// key seguro para IDs (evita choques)
const key = serviceTitle
  .toLowerCase()
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g, "")
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/(^-|-$)/g, "");

// IDs únicos
const idName = `${key}-name`;
const idZone = `${key}-zone`;
const idBrand = `${key}-brand`;
const idIssue = `${key}-issue`;
const idUrgency = `${key}-urgency`;
const idAvailability = `${key}-availability`;
const idBtn = `${key}-waBtn`;

// valores inyectados (bien)
const WA_NUMBER = SITE.whatsappE164; // "5491131377110"
---

<div class="form" data-booking={key}>
  <div class="formHeader">
    <h2 class="formTitle">Reservar visita por WhatsApp</h2>
    <p class="formSubtitle">Se abrirá WhatsApp con el mensaje listo para enviar.</p>
  </div>

  <div class="field">
    <label for={idName}>Nombre y apellido</label>
    <input id={idName} name="name" placeholder="Ej: Juan Pérez" autocomplete="name" required />
  </div>

  <div class="field">
    <label for={idZone}>Zona / Barrio</label>
    <input id={idZone} name="zone" placeholder="Ej: Caballito, CABA" autocomplete="address-level2" required />
  </div>

  <div class="field">
    <label for={idBrand}>Marca / Modelo (opcional)</label>
    <input id={idBrand} name="brand" placeholder="Ej: Samsung / Inverter" />
  </div>

  <div class="field field--full">
    <label for={idIssue}>¿Qué problema tiene?</label>
    <textarea
      id={idIssue}
      name="issue"
      placeholder="Contame síntomas, errores, ruidos, etc."
      required
    ></textarea>
  </div>

  <div class="field">
    <label for={idUrgency}>Urgencia</label>
    <select id={idUrgency} name="urgency" required>
      <option value="Hoy (si hay disponibilidad)">Hoy (si hay disponibilidad)</option>
      <option value="24-48 hs">24-48 hs</option>
      <option value="Esta semana">Esta semana</option>
    </select>
  </div>

  <div class="field">
    <label for={idAvailability}>Franja horaria preferida</label>
    <select id={idAvailability} name="availability" required>
      <option value="8 a 12">8 a 12</option>
      <option value="12 a 16">12 a 16</option>
      <option value="16 a 20">16 a 20</option>
    </select>
  </div>

  <div class="formActions">
    <a
      id={idBtn}
      class="btn btn--wa btn--waForm"
      href="#"
      rel="nofollow noopener"
      target="_blank"
      aria-disabled="true"
    >
      Reservar visita por WhatsApp
    </a>

    <p class="formHelp">
      <strong>Tip:</strong> completá nombre, zona y problema para habilitar el botón.
    </p>
  </div>

  <script is:inline define:vars={{ key, serviceTitle, WA_NUMBER }}>
    (() => {
      const root = document.querySelector(`.form[data-booking="${key}"]`);
      if (!root) return;

      const byId = (id) => root.querySelector(`#${CSS.escape(id)}`);
      const nameEl = byId(`${key}-name`);
      const zoneEl = byId(`${key}-zone`);
      const brandEl = byId(`${key}-brand`);
      const issueEl = byId(`${key}-issue`);
      const urgencyEl = byId(`${key}-urgency`);
      const availabilityEl = byId(`${key}-availability`);
      const btn = byId(`${key}-waBtn`);

      if (!nameEl || !zoneEl || !brandEl || !issueEl || !urgencyEl || !availabilityEl || !btn) return;

      // Limpieza FUERTE y estable para WhatsApp:
      // - elimina caracteres de formato (* _ ~ `) y cualquier asterisco que se cuele
      // - elimina invisibles (ZWSP/BOM)
      // - normaliza espacios
      // - convierte a ASCII seguro (sin tildes) para evitar reemplazos raros (·, °, *)
      const toAsciiSafe = (s) => {
        const str = String(s ?? "")
          .replace(/[\u200B-\u200D\uFEFF]/g, "")   // invisibles
          .replace(/[*_~`]/g, "")                  // formato WA
          .replace(/\u00B7/g, " ")                 // middle dot
          .replace(/\u00B0/g, " ")                 // degree (°) por si aparece
          .replace(/\r\n|\r/g, "\n")
          .replace(/[ \t]+/g, " ")
          .trim();

        // saca tildes/acentos, y deja solo ASCII imprimible + saltos de línea
        return str
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\x20-\x7E\n]/g, "");
      };

      const buildHref = () => {
        const name = toAsciiSafe(nameEl.value);
        const zone = toAsciiSafe(zoneEl.value);
        const brand = toAsciiSafe(brandEl.value);
        const issue = toAsciiSafe(issueEl.value);
        const urgency = toAsciiSafe(urgencyEl.value);
        const availability = toAsciiSafe(availabilityEl.value);
        const safeServiceTitle = toAsciiSafe(serviceTitle);

        const ok = name.length > 1 && zone.length > 1 && issue.length > 2;

        const lines = [
          "Hola! Me comunico desde la pagina web.",
          "Quiero coordinar una visita tecnica!",
          "",
          `- Servicio: ${safeServiceTitle}`,
          `- Marca/Modelo: ${brand || "-"}`,
          `- Problema: ${issue || "-"}`,
          "",
          "---------------------------------------------",
          "Contacto:",
          `- Nombre: ${name || "-"}`,
          `- Franja disponible para visita: ${availability}`,
          `- Urgencia: ${urgency}`,
          "",
          "Gracias! Quedo atento/a.",
        ];

        const msg = lines.join("\n");

        // Volvemos al endpoint clásico (suele ser más estable que wa.me en algunos casos)
        const url =
          "https://api.whatsapp.com/send?phone=" +
          WA_NUMBER +
          "&text=" +
          encodeURIComponent(msg);

        btn.href = url;

        btn.style.opacity = ok ? "1" : ".55";
        btn.style.pointerEvents = ok ? "auto" : "none";
        btn.setAttribute("aria-disabled", ok ? "false" : "true");
      };

      ["input", "change"].forEach((evt) => {
        root.querySelectorAll("input, textarea, select").forEach((el) => el.addEventListener(evt, buildHref));
      });

      btn.addEventListener("click", (e) => {
        buildHref();
        if (btn.getAttribute("aria-disabled") === "true") {
          e.preventDefault();
        }
      });

      buildHref();
    })();
  </script>
</div>
