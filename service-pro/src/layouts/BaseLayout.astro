---
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config/site";
import { canonical } from "@/lib/seo";

import "@/styles/tokens.css";
import "@/styles/base.css";
import "@/styles/components.css";

const {
  title = SITE.name,
  description = SITE.description,
  pathname = "/",
  ogImage = "/og.jpg",
  ogImageAlt = `${SITE.name} - Servicio técnico`,
  noIndex = false,
  /** Opcional: agrega JSON-LD extra por página */
  jsonLd = [],
} = Astro.props;

const url = canonical(pathname);

// OJO: SITE.domain hoy es placeholder. Cuando tengas dominio real, se actualiza y listo.
const ogAbs = ogImage.startsWith("http") ? ogImage : `${SITE.domain}${ogImage}`;

const jsonLdArray = Array.isArray(jsonLd) ? jsonLd : [jsonLd];

// Simple perf: preconnect a WA (los clicks abren wa.me)
const waOrigin = "https://wa.me";
---
<!doctype html>
<html lang="es-AR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="application-name" content={SITE.name} />
    <meta name="format-detection" content="telephone=no" />

    <title>{title}</title>
    <meta name="description" content={description} />

    <link rel="canonical" href={url} />

    <meta name="robots" content={noIndex ? "noindex,nofollow" : "index,follow"} />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta name="theme-color" content="#2b2c83" />

    <!-- Open Graph -->
    <meta property="og:locale" content="es_AR" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={SITE.name} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={url} />
    <meta property="og:image" content={ogAbs} />
    <meta property="og:image:alt" content={ogImageAlt} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogAbs} />

    <!-- Favicons -->
    <link rel="icon" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/favicon.svg" />

    <!-- Hints -->
    <link rel="preconnect" href={waOrigin} />
    <link rel="dns-prefetch" href={waOrigin} />

    <!-- Performance hints -->
    <link rel="preload" as="image" href="/og.jpg" />

    {jsonLdArray.map((obj) => (
      <script type="application/ld+json" set:html={JSON.stringify(obj)} />
    ))}
  </head>

  <body>
    <a class="skipLink" href="#main">Saltar al contenido</a>
    <Header />

    <main id="main">
      <slot />
    </main>

    <Footer />

    <!-- ✅ Scroll reveal + micro UX -->
    <script is:inline>
      (() => {
        const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        // Smooth anchor scroll (solo si no reduce motion)
        if (!prefersReduced) {
          document.querySelectorAll('a[href^="/#"], a[href^="#"]').forEach(a => {
            a.addEventListener("click", (e) => {
              const href = a.getAttribute("href") || "";
              const id = href.includes("#") ? href.split("#")[1] : "";
              if (!id) return;
              const el = document.getElementById(id);
              if (!el) return;
              e.preventDefault();
              el.scrollIntoView({ behavior: "smooth", block: "start" });
              history.pushState(null, "", href.startsWith("/") ? href : `/#${id}`);
            });
          });
        }

        // Reveal on scroll
        const els = Array.from(document.querySelectorAll("[data-reveal]"));
        if (!els.length) return;

        if (prefersReduced) {
          els.forEach(el => el.classList.add("is-visible"));
          return;
        }

        const io = new IntersectionObserver((entries) => {
          entries.forEach((en) => {
            if (en.isIntersecting) {
              en.target.classList.add("is-visible");
              io.unobserve(en.target);
            }
          });
        }, { threshold: 0.12, rootMargin: "0px 0px -8% 0px" });

        els.forEach(el => io.observe(el));
      })();
    </script>
  </body>
</html>
